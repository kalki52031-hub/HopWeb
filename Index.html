<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HopWeb Ultimate Studio</title>
    
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.4.12/ace.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        /* --- GLOBAL VARIABLES & RESET --- */
        :root {
            --primary: #2196f3;
            --bg: #f5f7fa;
            --text-main: #333;
            --green: #4caf50;
            --orange: #ff9800;
            --danger: #f44336;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { font-family: 'Roboto', sans-serif; background: var(--bg); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* --- UTILITY CLASSES --- */
        .hidden { display: none !important; }
        .view { width: 100%; height: 100%; position: absolute; background: var(--bg); display: flex; flex-direction: column; overflow-y: auto; transition: transform 0.2s ease; }
        
        /* Toast Notification */
        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #323232; color: white; padding: 10px 20px; border-radius: 20px; font-size: 14px; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 9999; }
        .toast.show { opacity: 1; bottom: 50px; }

        /* --- 1. HOME SCREEN STYLES --- */
        .home-header { padding: 50px 20px 30px; text-align: center; }
        .logo-area { font-size: 28px; font-weight: bold; color: var(--primary); display: flex; justify-content: center; gap: 10px; align-items: center; }
        .logo-icon { width: 32px; height: 42px; background: var(--primary); border-radius: 6px; position: relative; }
        .logo-icon::after { content:''; width:12px; height:12px; background:white; position:absolute; bottom:-4px; right:-4px; border-radius:50%; }
        
        .home-actions { display: flex; justify-content: center; gap: 15px; margin-top: 25px; }
        .pill-btn { background: white; border: 1px solid #ddd; padding: 10px 20px; border-radius: 30px; font-weight: 500; color: #555; display: flex; align-items: center; gap: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; }
        .icon-btn { width: 42px; height: 42px; border-radius: 50%; background: white; border: 1px solid #ddd; display: flex; align-items: center; justify-content: center; color: #555; cursor: pointer; }

        .project-list { padding: 20px; flex: 1; overflow-y: auto; }
        .p-card { background: white; padding: 15px; border-radius: 12px; display: flex; align-items: center; gap: 15px; margin-bottom: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; position: relative; }
        .p-icon { width: 40px; height: 50px; background: var(--primary); border-radius: 4px; position: relative; }
        .p-icon::after { content:''; width:12px; height:12px; background:white; position:absolute; bottom:-4px; right:-4px; border-radius:50%; }
        .p-del { position: absolute; right: 15px; color: #ccc; padding: 5px; }
        .p-del:hover { color: var(--danger); }

        .footer-nav { padding: 15px; display: flex; justify-content: space-between; align-items: flex-end; color: #999; font-size: 11px; font-weight: bold; background: var(--bg); }
        .f-item { display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .f-item.active { color: var(--primary); }

        /* --- 2. DASHBOARD STYLES --- */
        .dash-nav { height: 55px; background: white; display: flex; align-items: center; justify-content: space-between; padding: 0 15px; border-bottom: 1px solid #eee; }
        .dash-actions { padding: 15px; display: flex; gap: 10px; }
        .big-action { flex: 1; padding: 15px; border-radius: 10px; color: white; display: flex; align-items: center; justify-content: center; gap: 8px; font-weight: 500; font-size: 14px; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        .info-banner { background: #e3f2fd; border: 1px solid #bbdefb; color: #1565c0; padding: 12px; margin: 0 15px 15px; border-radius: 8px; font-size: 12px; display: flex; align-items: center; justify-content: space-between; }
        
        .file-header { padding: 0 15px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; height: 40px; }
        .file-tools { display: flex; align-items: center; gap: 15px; }
        .file-tools i { color: #555; cursor: pointer; }
        
        .search-container { flex: 1; display: flex; align-items: center; background: white; border: 1px solid #ddd; border-radius: 8px; padding: 0 10px; margin-right: 10px; height: 38px; }
        .search-input { border: none; flex: 1; margin-left: 8px; font-size: 14px; color: #333; height: 100%; }

        .file-item { background: white; padding: 10px 15px; margin: 0 15px 8px; border-radius: 8px; display: flex; align-items: center; justify-content: space-between; cursor: pointer; }
        .file-left { display: flex; align-items: center; gap: 12px; font-size: 14px; color: #333; overflow: hidden; }
        .file-thumb { width: 32px; height: 32px; border-radius: 4px; object-fit: cover; background: #eee; border: 1px solid #ddd; }
        .file-del { color: #ddd; }
        .file-del:hover { color: var(--danger); }

        /* --- 3. EDITOR STYLES --- */
        #view-editor { background: #272822; }
        .editor-top { height: 50px; background: #1e1e1e; display: flex; align-items: center; justify-content: space-between; padding: 0 10px; border-bottom: 1px solid #333; color: white; }
        .tabs-bar { display: flex; overflow-x: auto; background: #1e1e1e; height: 35px; align-items: flex-end; }
        .tab { padding: 8px 15px; font-size: 12px; color: #888; border-right: 1px solid #333; background: #252526; cursor: pointer; border-top: 2px solid transparent; white-space: nowrap; }
        .tab.active { background: #272822; color: #fff; border-top: 2px solid var(--primary); }
        
        #ace-editor { flex: 1; font-size: 14px; }
        #image-previewer { flex: 1; display: flex; align-items: center; justify-content: center; background: #333; overflow: hidden; }
        #image-previewer img { max-width: 90%; max-height: 90%; border: 2px solid #555; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }

        .fab-run { position: fixed; bottom: 25px; right: 25px; width: 55px; height: 55px; background: var(--green); border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 10; cursor: pointer; }

        /* --- 4. PREVIEW STYLES --- */
        #view-preview { background: white; z-index: 50; }
        .prev-nav { height: 45px; background: #f1f1f1; display: flex; align-items: center; justify-content: space-between; padding: 0 10px; border-bottom: 1px solid #ddd; }
        .console-drawer { height: 150px; background: #222; color: #0f0; position: absolute; bottom: 0; width: 100%; font-family: monospace; font-size: 12px; padding: 10px; overflow-y: auto; display: none; border-top: 2px solid #444; }
        .console-drawer.open { display: block; }
        .log-entry { margin-bottom: 4px; border-bottom: 1px solid #333; padding-bottom: 2px; }
        .log-error { color: #ff5555; }

        /* --- 5. SETTINGS (PRO UI) STYLES --- */
        .settings-content { padding: 20px; padding-bottom: 120px; background: #fff; }
        .settings-header { text-align: center; margin-bottom: 30px; }
        .settings-header h2 { font-weight: 400; font-size: 24px; margin-top: 10px; color: #333; }

        .set-card { background: #E0E0E0; border-radius: 20px; padding: 20px; margin-bottom: 20px; }

        .lbl-blue { color: #2196f3; font-size: 14px; margin-bottom: 5px; display: block; font-weight: 500; }
        .fin-line { width: 100%; background: transparent; border: none; border-bottom: 1px solid #999; padding: 8px 0; font-size: 16px; color: #333; margin-bottom: 20px; border-radius: 0; }
        .fin-line:focus { border-bottom: 2px solid #2196f3; }

        .img-picker-box { width: 100%; display: flex; justify-content: center; padding: 10px 0; }
        .img-slot { width: 60px; height: 80px; background: #2196f3; border-radius: 8px; position: relative; box-shadow: 0 4px 10px rgba(0,0,0,0.2); cursor: pointer; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        .img-slot img { width: 100%; height: 100%; object-fit: cover; }
        .img-slot::after { content:'+'; color: white; position: absolute; bottom: -5px; right: -5px; background: white; color: #2196f3; width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }

        .opt-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; }
        .opt-lbl { font-size: 16px; color: #333; }
        .switch { position: relative; display: inline-block; width: 46px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        input:checked + .slider { background-color: #2196f3; }
        input:checked + .slider:before { transform: translateX(22px); }

        /* --- NEW BOTTOM ACTION BAR (2 Buttons) --- */
        .action-bar-float { 
            position: fixed; 
            bottom: 30px; 
            left: 50%; 
            transform: translateX(-50%); 
            width: 90%; 
            max-width: 400px; 
            display: flex; 
            gap: 12px; 
            z-index: 100; 
        }

        .action-btn { 
            flex: 1; 
            height: 50px; 
            border-radius: 25px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: white; 
            font-weight: bold; 
            font-size: 14px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); 
            cursor: pointer; 
            gap: 8px;
            transition: transform 0.1s;
        }
        
        .action-btn:active { transform: scale(0.95); }

        /* Colors */
        .btn-share { background: #ff9800; } /* Orange for Share */
        .btn-build { background: #2196f3; } /* Blue for Build */

        /* --- MODAL STYLES --- */
        .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center; z-index: 1000; opacity: 0; pointer-events: none; transition: 0.3s; }
        .modal-overlay.show { opacity: 1; pointer-events: auto; }
        .modal-box { background: white; width: 85%; border-radius: 15px; padding: 20px; transform: scale(0.9); transition: 0.3s; position: relative; }
        .modal-overlay.show .modal-box { transform: scale(1); }
        
        .menu-list { list-style: none; margin-top: 10px; }
        .menu-item { padding: 15px; border-bottom: 1px solid #eee; font-size: 16px; color: #333; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .menu-item:last-child { border: none; }
        .menu-item:active { background: #f5f5f5; }

        /* Spinner Animation for Build Process */
        .spinner {
            width: 25px;
            height: 25px;
            border: 3px solid #e0e0e0;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

    </style>
</head>
<body>

    <div id="view-home" class="view">
        <div class="home-header">
            <div class="logo-area">
                <div class="logo-icon"></div> HopWeb
            </div>
            <div class="home-actions">
                <div class="pill-btn" onclick="openModal('create-modal')">
                    <i data-lucide="plus-circle" size="18"></i> Create Project
                </div>
                <div class="icon-btn" onclick="alert('Git features coming soon!')">
                    <i data-lucide="git-branch" size="18"></i>
                </div>
            </div>
        </div>

        <div class="project-list" id="project-list-container">
            </div>

        <div class="footer-nav">
            <div class="f-item active">
                <i data-lucide="home" size="20"></i> Home
            </div>
            <div class="f-item">
                <i data-lucide="zap" size="20"></i> ideaSky
            </div>
        </div>
    </div>

    <div id="view-dashboard" class="view hidden">
        <div class="dash-nav">
            <i data-lucide="arrow-left" onclick="goView('view-home')"></i>
            <span id="dash-title" style="font-weight: 500;">Project</span>
            <i data-lucide="settings" onclick="goView('view-settings')"></i>
        </div>

        <div class="dash-actions">
            <div class="big-action" style="background: var(--green);" onclick="showToast('PHP Server Started (Simulated)')">
                <i data-lucide="check-circle"></i> PHP Server
            </div>
            <div class="big-action" style="background: var(--orange);" onclick="goView('view-settings')">
                <i data-lucide="upload-cloud"></i> Publish
            </div>
        </div>

        <div class="info-banner">
            <span>Use database to improve project...</span>
            <i data-lucide="database" size="16"></i>
        </div>

        <div class="file-header">
            <div id="header-title-mode" style="display:flex; justify-content:space-between; width:100%; align-items:center;">
                <span style="font-weight: bold; font-size: 18px;">Website</span>
                <div class="file-tools">
                    <i data-lucide="search" size="20" onclick="toggleSearch(true)"></i>
                    <i data-lucide="git-branch" size="20" onclick="openModal('import-menu')"></i>
                    <i data-lucide="plus" size="20" onclick="openModal('file-modal')"></i>
                </div>
            </div>

            <div id="header-search-mode" class="hidden" style="display:flex; width:100%; align-items:center;">
                <div class="search-container">
                    <i data-lucide="search" size="16" color="#999"></i>
                    <input type="text" class="search-input" id="search-inp" placeholder="Search files..." onkeyup="handleSearch()">
                </div>
                <i data-lucide="x" size="20" color="#555" onclick="toggleSearch(false)"></i>
            </div>
        </div>

        <div id="file-list-container">
            </div>
    </div>

    <div id="view-editor" class="view hidden">
        <div class="editor-top">
            <i data-lucide="arrow-left" onclick="closeEditor()"></i>
            <span id="editor-fname">index.html</span>
            <i data-lucide="save" onclick="saveFile()"></i>
        </div>
        <div class="tabs-bar" id="tabs-container"></div>
        
        <div id="ace-editor"></div>
        <div id="image-previewer" class="hidden">
            <img id="img-prev-tag" src="">
        </div>

        <div class="fab-run" onclick="runProject()">
            <i data-lucide="play" fill="white"></i>
        </div>
    </div>

    <div id="view-preview" class="view hidden">
        <div class="prev-nav">
            <span style="font-weight: bold;">Browser</span>
            <div style="display:flex; gap:15px; align-items:center;">
                <i data-lucide="terminal" onclick="toggleConsole()" title="Toggle Console"></i>
                <i data-lucide="x" onclick="goView('view-editor')"></i>
            </div>
        </div>
        <iframe id="preview-frame" style="flex:1; border:none; background:white;"></iframe>
        <div class="console-drawer" id="console-drawer">
            <div>> Console Ready...</div>
        </div>
    </div>

    <div id="view-settings" class="view hidden">
        <div class="dash-nav">
            <i data-lucide="arrow-left" onclick="goView('view-dashboard')"></i>
            <span>App Configuration</span>
            <span></span>
        </div>

        <div class="settings-content">
            <div class="settings-header">
                <i data-lucide="smartphone" size="40" color="#4caf50"></i>
                <h2>Convert to Android Application</h2>
            </div>

            <div class="set-card">
                <label class="lbl-blue">Application Icon</label>
                <div class="img-picker-box">
                    <div class="img-slot" onclick="pickImage('icon')">
                        <img id="prev-icon" src="" style="display:none;">
                    </div>
                </div>

                <label class="lbl-blue">Application Name</label>
                <input type="text" class="fin-line" id="cfg-appname" value="MyWebApp">

                <label class="lbl-blue">Package Name</label>
                <input type="text" class="fin-line" id="cfg-pkg" value="com.mycompany.mywebapp">

                <label class="lbl-blue">Version Name</label>
                <input type="text" class="fin-line" id="cfg-vername" value="1.0.0">

                <label class="lbl-blue">Version Code</label>
                <input type="number" class="fin-line" id="cfg-vercode" value="1">

                <div class="opt-row">
                    <label class="lbl-blue" style="margin:0;">Title Bar Background Color</label>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span id="col-disp">#3F51B5</span>
                        <input type="color" id="cfg-color" value="#3F51B5" onchange="document.getElementById('col-disp').innerText=this.value" style="border:none; background:none; width:30px; height:30px;">
                    </div>
                </div>
            </div>

            <div class="set-card">
                <label class="lbl-blue">Screen Rotation Method</label>
                <select class="fin-line" id="cfg-rot">
                    <option value="auto">Auto Rotate</option>
                    <option value="portrait">Portrait</option>
                    <option value="landscape">Landscape</option>
                </select>

                <label class="lbl-blue">Homepage</label>
                <input type="text" class="fin-line" id="cfg-home" value="index.html">
            </div>

            <div class="set-card">
                <label class="lbl-blue" style="margin-bottom:15px;">PHP Environment Options</label>
                
                <div class="opt-row">
                    <span class="opt-lbl">Carry PHP Environment</span>
                    <label class="switch">
                        <input type="checkbox" id="cfg-php">
                        <span class="slider"></span>
                    </label>
                </div>

                <label class="lbl-blue" style="margin-top:10px;">PHP Server Port</label>
                <input type="number" class="fin-line" id="cfg-port" value="57249">
            </div>

            <div class="set-card">
                <label class="lbl-blue">Image of Splash Page</label>
                <div class="img-picker-box">
                    <div class="img-slot" onclick="pickImage('splash')" style="background:#ddd;">
                        <img id="prev-splash" src="" style="display:none;">
                    </div>
                </div>
            </div>

            <div class="set-card">
                <label class="lbl-blue" style="margin-bottom:15px;">More Options</label>
                <div id="toggles-container"></div>
            </div>

            <div class="action-bar-float">
                <div class="action-btn btn-share" onclick="triggerSystemShare()">
                    <i data-lucide="share-2" size="20"></i> Share Feature
                </div>
                
                <div class="action-btn btn-build" onclick="startBuild()">
                    <i data-lucide="check" size="20"></i> BUILD APK
                </div>
            </div>

        </div> </div>

    <div class="modal-overlay" id="modal-php-warn">
        <div class="modal-box" style="width: 80%; max-width: 350px;">
            <h3 style="color:#333; margin-bottom:10px;">The App Will Carry PHP Environment</h3>
            <p style="color:#666; font-size:14px; line-height:1.5;">
                It will make the installer file about 37MB larger. Furthermore, your App can only be installed in ARM 64 CPU devices.
            </p>
            <div style="text-align:right; margin-top:20px; display:flex; justify-content:flex-end; gap:20px;">
                <span style="color:#2196f3; font-weight:bold; font-size:14px; cursor:pointer;" onclick="closeModal('modal-php-warn')">CANCEL</span>
                <span style="color:#2196f3; font-weight:bold; font-size:14px; cursor:pointer;" onclick="startRealProcess()">OK</span>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="modal-loading">
        <div class="modal-box" style="width: 250px; display:flex; align-items:center; gap:20px; padding: 25px;">
            <div class="spinner"></div>
            <span style="color:#333; font-weight:500;">Please wait...</span>
        </div>
    </div>

    <div class="modal-overlay" id="modal-finish">
        <div class="modal-box" style="width: 80%; max-width: 350px;">
            <h3 style="color:#333; margin-bottom:10px;">Conversion Finished</h3>
            <p style="color:#666; font-size:14px;">Now, you can share the installer to others.</p>
            <div style="text-align:right; margin-top:20px;">
                <span style="color:#2196f3; font-weight:bold; font-size:14px; cursor:pointer;" onclick="triggerSystemShare()">OK</span>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="create-modal">
        <div class="modal-box">
            <h3>New Project</h3>
            <label class="lbl-blue" style="margin-top:10px;">Project Name</label>
            <input type="text" class="fin-line" id="new-p-name" placeholder="My Website">
            <div style="text-align:right; margin-top:20px;">
                <span style="color:#f44336; margin-right:15px; font-weight:bold; cursor:pointer;" onclick="closeModal('create-modal')">CANCEL</span>
                <span style="color:var(--primary); font-weight:bold; cursor:pointer;" onclick="createProject()">CREATE</span>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="file-modal">
        <div class="modal-box">
            <h3>New File</h3>
            <label class="lbl-blue" style="margin-top:10px;">File Name</label>
            <input type="text" class="fin-line" id="new-f-name">
            <div style="text-align:right; margin-top:20px;">
                <span style="color:#f44336; margin-right:15px; font-weight:bold; cursor:pointer;" onclick="closeModal('file-modal')">CANCEL</span>
                <span style="color:var(--primary); font-weight:bold; cursor:pointer;" onclick="createFile()">CREATE</span>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="import-menu">
        <div class="modal-box" style="padding:0; overflow:hidden;">
            <div style="padding: 15px 20px; border-bottom:1px solid #eee; font-weight:bold; font-size:18px;">
                Import
            </div>
            <div class="menu-list">
                <div class="menu-item" onclick="triggerImport('media')">
                    Import Media File
                </div>
                <div class="menu-item" onclick="triggerImport('file')">
                    Import Other Type File
                </div>
            </div>
            <div style="text-align:right; padding:15px;">
                 <span style="color:#f44336; font-weight:bold; cursor:pointer;" onclick="closeModal('import-menu')">CANCEL</span>
            </div>
        </div>
    </div>

    <div class="toast" id="toast">Message</div>

    <input type="file" id="import-media" hidden accept="image/*,video/*,audio/*" onchange="handleFileSelect(this, 'binary')">
    <input type="file" id="import-any" hidden onchange="handleFileSelect(this, 'auto')">
    <input type="file" id="sys-img-picker" hidden accept="image/*">

<script>
    // --- GLOBAL VARIABLES ---
    let projects = JSON.parse(localStorage.getItem('hop_projects')) || [];
    let curProj = null;
    let curFile = null;
    let editor = null;
    let currentSearch = ""; 

    // --- INITIALIZATION ---
    window.onload = () => {
        lucide.createIcons();
        initEditor();
        renderProjects();
        initSettingsUI();
    };

    function initEditor() {
        editor = ace.edit("ace-editor");
        editor.setTheme("ace/theme/monokai");
        editor.session.setMode("ace/mode/html");
        editor.setOptions({ fontSize: "14pt", wrap: true, showPrintMargin: false });
    }

    // --- NAVIGATION LOGIC ---
    function goView(id) {
        document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        lucide.createIcons();
    }

    function openModal(id) {
        document.getElementById(id).classList.add('show');
        const inp = document.getElementById(id).querySelector('input');
        if(inp && !inp.hidden) inp.focus();
    }
    
    function closeModal(id) {
        document.getElementById(id).classList.remove('show');
    }

    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 2000);
    }

    // --- PROJECT MANAGEMENT LOGIC ---
    function renderProjects() {
        const list = document.getElementById('project-list-container');
        list.innerHTML = '';
        projects.forEach((p, idx) => {
            list.innerHTML += `
                <div class="p-card" onclick="openProject(${idx})">
                    <div class="p-icon"></div>
                    <div>
                        <h4 style="margin-bottom:4px;">${p.name}</h4>
                        <span style="font-size:12px; color:#999;">${p.date}</span>
                    </div>
                    <i data-lucide="trash-2" class="p-del" onclick="deleteProject(event, ${idx})"></i>
                </div>
            `;
        });
        lucide.createIcons();
    }

    function createProject() {
        const name = document.getElementById('new-p-name').value;
        if(!name) return;
        const newP = {
            name: name,
            date: new Date().toLocaleDateString(),
            files: {
                'index.html': '<h1>Hello World</h1>\n<img src="icon.png" width="100">',
                'style.css': 'body { font-family: sans-serif; padding: 20px; }'
            },
            config: {} 
        };
        projects.unshift(newP);
        saveData();
        renderProjects();
        closeModal('create-modal');
    }

    function deleteProject(e, idx) {
        e.stopPropagation();
        if(confirm('Delete ' + projects[idx].name + '?')) {
            projects.splice(idx, 1);
            saveData();
            renderProjects();
        }
    }

    function openProject(idx) {
        curProj = projects[idx];
        document.getElementById('dash-title').innerText = curProj.name;
        
        // Restore Settings
        if(curProj.buildConfig) {
           document.getElementById('cfg-appname').value = curProj.buildConfig.appName;
           document.getElementById('cfg-pkg').value = curProj.buildConfig.pkgName;
        } else {
           document.getElementById('cfg-appname').value = curProj.name;
        }
        
        // Restore Images
        if(curProj.config && curProj.config.icon) {
            document.getElementById('prev-icon').src = curProj.config.icon;
            document.getElementById('prev-icon').style.display = 'block';
        }
        if(curProj.config && curProj.config.splash) {
            document.getElementById('prev-splash').src = curProj.config.splash;
            document.getElementById('prev-splash').style.display = 'block';
        }

        currentSearch = "";
        toggleSearch(false);
        renderFiles();
        goView('view-dashboard');
    }

    function saveData() {
        try {
            localStorage.setItem('hop_projects', JSON.stringify(projects));
        } catch(e) {
            alert("Storage limit reached! Delete old projects or files.");
        }
    }

    // --- FILES & SEARCH ---
    function toggleSearch(show) {
        const normal = document.getElementById('header-title-mode');
        const search = document.getElementById('header-search-mode');
        const inp = document.getElementById('search-inp');

        if(show) {
            normal.style.display = 'none';
            search.style.display = 'flex';
            search.classList.remove('hidden');
            inp.value = '';
            inp.focus();
        } else {
            search.style.display = 'none';
            normal.style.display = 'flex';
            currentSearch = "";
            renderFiles();
        }
        lucide.createIcons();
    }

    function handleSearch() {
        currentSearch = document.getElementById('search-inp').value.toLowerCase();
        renderFiles();
    }

    function renderFiles() {
        const list = document.getElementById('file-list-container');
        list.innerHTML = '';
        
        const files = Object.keys(curProj.files);
        const filteredFiles = files.filter(f => f.toLowerCase().includes(currentSearch));

        if(filteredFiles.length === 0) {
            list.innerHTML = `<div style="text-align:center; padding:20px; color:#999;">No files found</div>`;
            return;
        }
        
        filteredFiles.forEach(f => {
            const content = curProj.files[f];
            const isImg = f.match(/\.(jpg|jpeg|png|gif|svg|webp)$/i);
            const isBinary = content.startsWith('data:image');

            let iconHtml = '';
            if (isImg && isBinary) {
                iconHtml = `<img src="${content}" class="file-thumb">`;
            } else {
                let icon = f.endsWith('css') ? 'palette' : (f.endsWith('js') ? 'file-code-2' : 'file-code');
                let col = f.endsWith('css') ? '#e91e63' : (f.endsWith('js') ? '#ff9800' : '#2196f3');
                iconHtml = `<i data-lucide="${icon}" color="${col}" size="24"></i>`;
            }
            
            list.innerHTML += `
                <div class="file-item" onclick="openFile('${f}')">
                    <div class="file-left">
                        ${iconHtml}
                        <span>${f}</span>
                    </div>
                    <i data-lucide="trash-2" class="file-del" size="18" onclick="deleteFile(event, '${f}')"></i>
                </div>
            `;
        });
        lucide.createIcons();
    }

    function createFile() {
        const name = document.getElementById('new-f-name').value;
        if(name && curProj) {
            if(curProj.files[name]) { showToast('File already exists'); return; }
            curProj.files[name] = "";
            saveData();
            renderFiles();
            closeModal('file-modal');
        }
    }

    function deleteFile(e, name) {
        e.stopPropagation();
        delete curProj.files[name];
        saveData();
        renderFiles();
    }

    // --- IMPORT SYSTEM ---
    function triggerImport(type) {
        closeModal('import-menu');
        if(type === 'media') document.getElementById('import-media').click();
        else document.getElementById('import-any').click();
    }

    function handleFileSelect(input, mode) {
        const file = input.files[0];
        if(!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const content = e.target.result;
            if(curProj.files[file.name]) {
                if(!confirm('Overwrite ' + file.name + '?')) return;
            }
            curProj.files[file.name] = content;
            saveData();
            renderFiles();
            showToast('Imported ' + file.name);
        };

        if (mode === 'binary' || file.type.startsWith('image/')) {
            reader.readAsDataURL(file);
        } else {
            reader.readAsText(file);
        }
        input.value = '';
    }

    // --- EDITOR SYSTEM ---
    function openFile(name) {
        curFile = name;
        document.getElementById('editor-fname').innerText = name;
        
        const content = curProj.files[name];
        const isImg = name.match(/\.(jpg|jpeg|png|gif|svg|webp)$/i);

        const editorDiv = document.getElementById('ace-editor');
        const prevDiv = document.getElementById('image-previewer');
        const imgTag = document.getElementById('img-prev-tag');

        if(isImg && content.startsWith('data:image')) {
            editorDiv.classList.add('hidden');
            prevDiv.classList.remove('hidden');
            imgTag.src = content;
        } else {
            prevDiv.classList.add('hidden');
            editorDiv.classList.remove('hidden');
            const mode = name.endsWith('css') ? 'css' : (name.endsWith('js') ? 'javascript' : 'html');
            editor.session.setMode("ace/mode/" + mode);
            editor.setValue(content, -1);
        }
        
        const tabs = document.getElementById('tabs-container');
        tabs.innerHTML = Object.keys(curProj.files).map(f => 
            `<div class="tab ${f===name?'active':''}" onclick="saveFile();openFile('${f}')">${f}</div>`
        ).join('');
        
        goView('view-editor');
    }

    function saveFile() {
        if(curProj && curFile) {
            const isImg = curFile.match(/\.(jpg|jpeg|png|gif|svg|webp)$/i);
            if(!isImg) {
                curProj.files[curFile] = editor.getValue();
                saveData();
                showToast('Saved');
            }
        }
    }

    function closeEditor() {
        saveFile();
        goView('view-dashboard');
    }

    // --- PREVIEW (RUN) LOGIC ---
    function runProject() {
        saveFile();
        goView('view-preview');
        const frame = document.getElementById('preview-frame');
        
        let runFile = 'index.html';
        if (curFile && curFile.endsWith('.html')) {
            runFile = curFile;
        }
        
        let code = curProj.files[runFile] || "";
        if(!code) return frame.srcdoc = "<h1>Error: File not found</h1>";

        const sortedFiles = Object.keys(curProj.files).sort((a,b) => b.length - a.length);

        let cssBlock = "";
        let jsBlock = "";

        sortedFiles.forEach(f => {
            const content = curProj.files[f];

            if(f.match(/\.(jpg|jpeg|png|gif|svg|webp|mp3|mp4)$/i)) {
                let reg = new RegExp(`(src|href)=["']${f}["']`, 'g');
                code = code.replace(reg, `$1="${content}"`);
                code = code.split(`url(${f})`).join(`url(${content})`);
            }

            if(f.endsWith('.css')) cssBlock += `\n/* ${f} */\n${content}\n`;
            if(f.endsWith('.js')) jsBlock += `\n\n<script>${content}<\/script>\n`;
        });

        if(code.includes('</head>')) {
            code = code.replace('</head>', `<style>${cssBlock}</style></head>`);
        } else {
            code += `<style>${cssBlock}</style>`;
        }

        const hijacker = `
        <script>
            window.onerror = function(msg, url, line) { 
                window.parent.postMessage({type:'err', msg: msg + " (Line: " + line + ")"}, '*'); 
            };
            console.log = function(m){ 
                window.parent.postMessage({type:'log', msg: typeof m === 'object' ? JSON.stringify(m) : m}, '*'); 
            };
            console.error = function(m){ 
                window.parent.postMessage({type:'err', msg: m}, '*'); 
            };
        <\/script>`;

        code = code.replace('<body>', '<body>' + hijacker);
        
        if(code.includes('</body>')) {
            code = code.replace('</body>', jsBlock + '</body>');
        } else {
            code += jsBlock;
        }

        frame.srcdoc = code;
    }
    
    window.addEventListener('message', (e) => {
        if(e.data.type === 'log' || e.data.type === 'err') {
            const cons = document.getElementById('console-drawer');
            const d = document.createElement('div');
            d.className = 'log-entry ' + (e.data.type==='err'?'log-error':'');
            d.innerText = "> " + e.data.msg;
            cons.appendChild(d);
        }
    });
    
    function toggleConsole() {
        document.getElementById('console-drawer').classList.toggle('open');
    }

    // --- SETTINGS UI & TOGGLES ---
    const toggleList = [
        {id: 'full', lbl: 'Fullscreen Mode', on: false},
        {id: 'notitle', lbl: 'Hide Title Bar', on: false},
        {id: 'longpress', lbl: 'Allow Long Press', on: true},
        {id: 'loadui', lbl: 'Show Loading UI', on: true},
        {id: 'zoom', lbl: 'Allow Zoom', on: true},
        {id: 'pcmode', lbl: 'PC Mode', on: false},
        {id: 'autoplay', lbl: 'Allow Media Autoplay', on: false},
        {id: 'refresh', lbl: 'Allow Swiping to Refresh', on: true},
        {id: 'cam', lbl: 'Allow Using Camera', on: false},
        {id: 'mic', lbl: 'Allow Using Microphone', on: false},
    ];

    function initSettingsUI() {
        const con = document.getElementById('toggles-container');
        con.innerHTML = '';
        toggleList.forEach(t => {
            con.innerHTML += `
            <div class="opt-row">
                <span class="opt-lbl">${t.lbl}</span>
                <label class="switch">
                    <input type="checkbox" id="cfg-${t.id}" ${t.on ? 'checked' : ''}>
                    <span class="slider"></span>
                </label>
            </div>`;
        });
    }

    let pickerMode = null;
    function pickImage(mode) {
        pickerMode = mode;
        document.getElementById('sys-img-picker').click();
    }

    document.getElementById('sys-img-picker').onchange = function(e) {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const res = e.target.result;
            const img = document.getElementById(pickerMode === 'icon' ? 'prev-icon' : 'prev-splash');
            img.src = res;
            img.style.display = 'block';
            
            if(!curProj.config) curProj.config = {};
            curProj.config[pickerMode] = res; 
            saveData();
        };
        reader.readAsDataURL(file);
    };

    // --- NEW BUILD PROCESS (VIDEO STYLE) ---
    
    // Step 1: Triggered by "BUILD APK" button
    function startBuild() {
        // First show the PHP Warning Modal
        openModal('modal-php-warn');
    }

    // Step 2: User clicked OK on Warning
    function startRealProcess() {
        closeModal('modal-php-warn');
        openModal('modal-loading'); // Show Spinner

        // Wait 2.5 seconds to simulate build
        setTimeout(() => {
            closeModal('modal-loading');
            openModal('modal-finish'); // Show Finish
        }, 2500);
    }

    // Step 3: Trigger System Share (Real Logic)
    async function triggerSystemShare() {
        closeModal('modal-finish');

        // Safety check to ensure project config exists
        if(!curProj.buildConfig) curProj.buildConfig = {};
        
        // Save current inputs to config
        curProj.buildConfig.appName = document.getElementById('cfg-appname').value;
        curProj.buildConfig.pkgName = document.getElementById('cfg-pkg').value;
        curProj.buildConfig.verName = document.getElementById('cfg-vername').value;
        curProj.buildConfig.verCode = document.getElementById('cfg-vercode').value;
        curProj.buildConfig.rotation = document.getElementById('cfg-rot').value;
        curProj.buildConfig.home = document.getElementById('cfg-home').value;
        
        toggleList.forEach(t => {
            curProj.buildConfig[t.id] = document.getElementById('cfg-' + t.id).checked;
        });

        // Generate the ZIP (pretending to be APK)
        const zip = new JSZip();
        const jsonConfig = JSON.stringify(curProj.buildConfig, null, 2);
        zip.file("hopweb_config.json", jsonConfig);
        
        Object.keys(curProj.files).forEach(name => {
            const content = curProj.files[name];
            if(content.startsWith('data:')) {
                const base64Data = content.split(',')[1];
                zip.file(name, base64Data, {base64: true});
            } else {
                zip.file(name, content);
            }
        });

        try {
            const content = await zip.generateAsync({type:"blob"});
            
            // Create a file object for native sharing
            // MIME type chosen to help Android identify it as an installer-like package
            const file = new File([content], curProj.name + "_installer.apk", { type: "application/vnd.android.package-archive" });
            
            // Trigger Native Share
            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                await navigator.share({
                    files: [file],
                    title: curProj.name,
                    text: 'Here is your generated app installer.'
                });
                showToast('Shared Successfully!');
            } else {
                // Fallback if sharing is not supported (e.g., Desktop or non-HTTPS)
                saveAs(content, curProj.name + "_installer.zip");
                showToast('Share not supported here, downloaded instead.');
            }
        } catch (err) {
            console.error(err);
            showToast('Error sharing file: ' + err.message);
        }
    }
</script>
</body>
</html>
